# Telegram Shift Management Bot

Полностью готовый к запуску Telegram-бот для управления рабочими сменами. Бот помогает авторизовывать сотрудников, собирать фото-отметки начала и окончания смен, формировать отчёты и визуализации, а также присылать управляющим ежедневные уведомления.

## Возможности

- Авторизация через deep-link, номер телефона, капчу или код приглашения.
- Ролевые модели: оператор, управляющий, владелец.
- Утренние и вечерние окна отметок с проверкой свежести фото.
- Планировщик APScheduler для напоминаний, отчётов и агрегаций.
- Построение графиков посещаемости (matplotlib) и выгрузка CSV.
- Управление настройками чата (окна, таймзона, алерты, выходные).
- Поддержка нескольких чатов и таймзон.
- Docker-инфраструктура с PostgreSQL и Redis.

## Быстрый старт

1. Скопируйте шаблон окружения и заполните значения:

   ```bash
   cp .env.example .env
   ```

   Обязательные параметры `.env`:

   ```env
   BOT_TOKEN=      # токен Telegram-бота
   DATABASE_URL=   # строка подключения (например postgresql+asyncpg://postgres:postgres@db:5432/postgres)
   REDIS_URL=redis://redis:6379/0
   OWNER_TELEGRAM_ID=123456789   # Telegram ID владельца
   TZ=Europe/Sofia
   PHONE_SALT=super-secret-salt  # соль для хеширования номеров телефонов
   LOG_LEVEL=INFO
   SCHEDULER_TZ=UTC
   ```

2. Запустите docker-compose:

   ```bash
   make run
   ```

   Команда собирает образ бота, поднимает PostgreSQL и Redis и запускает планировщик. После старта бот доступен по токену, а health-check слушает `http://localhost:8080/health`.

3. Выполните миграции (если нужно отдельно):

   ```bash
   make migrate
   ```

4. (Опционально) Заполните тестовые данные:

   ```bash
   make seed
   ```

5. Тесты и статический анализ:

   ```bash
   make test   # pytest
   make lint   # быстрая проверка синтаксиса
   ```

## Основные сценарии

1. **Добавление в чат** — бот приветствует участников и даёт deep-link для авторизации.
2. **Авторизация** — в личке пользователь выбирает способ (номер телефона, капча, код). Номер телефона хешируется SHA-256 + соль, логируются только технические данные.
3. **Сбор отметок** — утром и вечером оператор отправляет фото в личку, затем подтверждает кнопку. Фото старше 2 минут отклоняется, повторная отметка невозможна.
4. **Напоминания и отчёты** — каждые 5 минут APScheduler проверяет пропуски и шлёт алерты управляющим. В 00:10 формируется агрегированная таблица `daily_stats`.
5. **Отчёты** — команда `/report` или `/dashboard` присылает график (PNG 1200×600) и CSV-файл. Управляющие видят статистику чата, владелец — глобально.
6. **Настройки** — `/settings` позволяет менять окна отметок, таймзону, алерты и учёт выходных. Управляющие управляют только своими чатами, владелец — глобально.
7. **Экспорт** — `/export` отправляет CSV с полями `date,user,chat,type,status` (телефоны обрезаны до последних 4 цифр).

## Команды Telegram

- `/help` — краткая справка.
- `/my` — список чатов и текущие роли.
- `/setrole` — установка ролей (владелец или администратор чата).
- `/report`, `/dashboard`, `/chats`, `/export` — статистика и выгрузки.
- `/settings` — редактирование параметров чата.
- `/health` — ответ `OK` (используется в Docker health-check).
- `/lang` — переключение языка интерфейса (ru/en).
- `/link` — повторное получение deep-link для авторизации (в группе).

## Deep-link авторизация

Каждый чат получает ссылку вида `https://t.me/<bot_username>?start=<payload>`, где `<payload>` — base64-кодированный идентификатор чата. Пользователь открывает ссылку, проходит авторизацию и привязывается к чату.

## Структура проекта

```
app/
 ├── bot.py             # входная точка aiogram + health-check
 ├── config.py          # Pydantic настройки
 ├── db.py              # SQLAlchemy engine и сессии
 ├── models.py          # ORM модели
 ├── scheduler.py       # задачи APScheduler
 ├── charts.py          # генерация графиков
 ├── services/          # сервисы (уведомления)
 ├── routers/           # обработчики aiogram
 ├── migrations/        # Alembic миграции
 ├── scripts/           # утилиты (seed)
 └── tests/             # pytest-тесты
```

## Приватность и данные

- Номера телефонов не хранятся в явном виде (SHA-256 + соль, сохранены последние 4 цифры).
- В логах отсутствуют персональные данные, фиксируются только служебные идентификаторы.
- CSV-экспорт содержит только усечённые контактные данные.
- Все действия пользователей протоколируются (user_id, chat_id, action, timestamp).

## Тесты вне Docker

Если вы запускаете `pytest` напрямую на рабочей машине, убедитесь, что заранее установлены все зависимости из `requirements.txt`:

```bash
python -m pip install --upgrade pip
pip install -r requirements.txt
```

В изолированных окружениях без доступа в интернет установка пакетов будет недоступна и тесты завершатся ошибкой `ModuleNotFoundError`. В этом случае используйте контейнерную сборку (`make run`/`docker-compose up`), где зависимости устанавливаются при сборке образа.

## Сценарий тестирования

1. Добавьте бота в рабочий чат — бот пришлёт приветствие и ссылку.
2. Оператор открывает личку по ссылке и проходит авторизацию (например, через номер телефона).
3. В утреннем окне оператор отправляет свежее фото и нажимает «Я пришёл на работу» — отметка сохраняется.
4. Попытка повторить отметку приведёт к сообщению «✅ Отметка уже зафиксирована».
5. Вечером аналогично фиксируется завершение смены.
6. Управляющий получает отчёт с графиком и CSV, владелец — сводку по всем чатам через `/report` → «Неделя».
7. Пользователь без авторизации получает напоминание пройти авторизацию.
8. Для чата в другой таймзоне окна работают корректно благодаря настройке `/settings`.
9. После рестарта контейнера FSM хранится в Redis, поэтому состояние не теряется.

## Лицензия

Проект распространяется под MIT License.
